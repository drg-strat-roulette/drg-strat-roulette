<!-- Header bar -->
<div class="d-flex flex-row justify-content-between header-bar">
    <img *ngIf="!hideLogo" class="drg-logo" src="assets/drg-logo.png">
    <div class="title-container">
        <h1 class="strat-roulette-title">Strategy Roulette</h1>
    </div>
    <div class="header-controls d-flex flex-row">
        <button
            #tooltip="matTooltip"
            matTooltip="Share"
            matTooltipShowDelay="500"
            mat-icon-button
            (click)="copyShareText()"
            class="m-1">
            <mat-icon class="white-icon">share</mat-icon>
        </button>
        <button
            #tooltip="matTooltip"
            matTooltip="Settings"
            matTooltipShowDelay="500"
            mat-icon-button
            (click)="settingsMenuCollapsed = !settingsMenuCollapsed"
            class="m-1">
            <mat-icon class="white-icon">settings</mat-icon>
        </button>
    </div>
</div>

<mat-drawer-container class="drawer-container">
    <!-- Queued strategies drawer -->
    <mat-drawer #drawer mode="over" class="queued-strats-drawer">
        <h2 class="queued-strats-drawer-header d-flex flex-row justify-content-between">
            Queued strategies
            <mat-icon
                #tooltip="matTooltip"
                matTooltip="Queued strategies rely on RNG to be attempted. As such, they are queued up and can be attempted when the opportunity presents itself. They can be done in any order. Click on a queued strategy to view it again, and check it off to remove it from queue.">help</mat-icon>
        </h2>
        <!-- List of queued strategies -->
        <div
            *ngFor="let queuedStrat of queuedStrats"
            class="queued-strat d-flex flex-row"
            (click)="strategy = queuedStrat; drawer.toggle()">
            <button
                mat-icon-button
                class="m-1"
                (click)="removeQueuedStrategy(queuedStrat.id)">
                <mat-icon>check</mat-icon>
            </button>
            <div class="queued-strat-name">
                {{ queuedStrat.name }}
            </div>
        </div>
    </mat-drawer>

    <!-- Main page contents -->
    <mat-drawer-content>
        <div class="page-container" [ngStyle]="{
            backgroundImage: 'linear-gradient( rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5) ), url(/assets/bg/' + background + ')'
        }">
            <div class="container p-2 page-contents-container">
        
                <!-- Settings collapsible -->
                <div [collapse]="settingsMenuCollapsed" [isAnimated]="true">
                    <div class="d-flex flex-row flex-wrap justify-content-between">
                        <div>
                            <!-- Tags selection -->
                            <h2>Tags</h2>
                            <div *ngFor="let tag of tags" class="m-1 ms-4">
                                <mat-checkbox
                                    [(ngModel)]="tag.checked"
                                    (ngModelChange)="saveSettings()"
                                    #tooltip="matTooltip"
                                    [matTooltip]="'Include strategies which ' + tag.tooltipDetails"
                                    matTooltipPosition="right"
                                    matTooltipShowDelay="250">
                                    {{ tag.type }}
                                </mat-checkbox>
                            </div>
        
                            <!-- Make strategy-specific decisions -->
                            <h2>Strategy decisions</h2>
                            <div class="m-1 ms-4">
                                <mat-checkbox
                                    [(ngModel)]="makeStratDecisionsAutomatically"
                                    (ngModelChange)="saveSettings()"
                                    #tooltip="matTooltip"
                                    matTooltip="Randomly make strategy-specific decisions for me. (e.g. Some strategies require selecting one dwarf to perform a specific role)"
                                    matTooltipPosition="right"
                                    matTooltipShowDelay="250">
                                    Choose for me
                                </mat-checkbox>
                            </div>
        
                            <!-- Specific missions selection -->
                            <h2>Missions</h2>
                            <div class="m-1 ms-4">
                                <mat-checkbox
                                    [(ngModel)]="preChosenMissions"
                                    (ngModelChange)="saveSettings()"
                                    #tooltip="matTooltip"
                                    matTooltip="Roll for strategies that are compatible with the mission entered below."
                                    matTooltipPosition="right"
                                    matTooltipShowDelay="250">
                                    Specific missions
                                </mat-checkbox>
                            </div>

                            <h2>Other</h2>
                            <button
                                class="other-settings-button"
                                mat-raised-button
                                #tooltip="matTooltip"
                                matTooltip="Resets all settings to their default configurations"
                                matTooltipShowDelay="500"
                                color="primary"
                                (click)="resetAllSettings()">
                                Reset all
                            </button>
                            <button
                                class="other-settings-button"
                                mat-raised-button
                                #tooltip="matTooltip"
                                matTooltip="Clears all data from browser cache"
                                matTooltipShowDelay="500"
                                color="primary"
                                (click)="clearAllCachedData()">
                                Clear cache
                            </button>
                        </div>
        
                        <!-- Team configuration -->
                        <div>
                            <h2>Team details</h2>
        
                            <!-- Add a dwarf -->
                            <div
                                class="add-dwarf-button-container"
                                #tooltip="matTooltip"
                                [matTooltip]="dwarves.length >= 4 ? 'Team is full' : ''"
                                matTooltipPosition="right"
                                matTooltipShowDelay="250">
                                <button
                                    mat-raised-button
                                    color="primary"
                                    [disabled]="dwarves.length >= 4"
                                    (click)="addDwarf()">
                                    Add a dwarf
                                </button>
                            </div>
        
                            <!-- Dwarf info -->
                            <div *ngFor="let dwarf of dwarves; let i = index">
                                <div class="d-flex flex-col flex-wrap">
                                    <mat-form-field appearance="fill" class="m-1">
                                        <mat-label>Name</mat-label>
                                        <input matInput type="text" [(ngModel)]="dwarf.name" (ngModelChange)="saveSettings()">
                                    </mat-form-field>
                                    <div>
                                        <mat-form-field appearance="fill" class="m-1 dwarf-class-select">
                                            <mat-label>Classes</mat-label>
                                            <mat-select [(ngModel)]="dwarf.classes" (ngModelChange)="saveSettings()" multiple>
                                                <mat-option [value]="dwarfClass" *ngFor="let dwarfClass of dwarfClasses" [disabled]="dwarf.classes.length === 1 && dwarf.classes.includes(dwarfClass)">{{ dwarfClass }}</mat-option>
                                            </mat-select>
                                        </mat-form-field>
                                        <button mat-icon-button color="warn" class="m-1" (click)="removeDwarf(i)"><mat-icon>close</mat-icon></button>
                                    </div>
                                </div>
                            </div>
        
                            <!-- Ghost dwarf info (Rendered a 0px height for flex consistency purposes) -->
                            <div *ngIf="dwarves.length === 0" class="d-flex flex-col flex-wrap fake-dwarf-info">
                                <mat-form-field appearance="fill" class="m-1">
                                    <input matInput type="text">
                                </mat-form-field>
                                <div>
                                    <mat-form-field appearance="fill" class="m-1 dwarf-class-select">
                                        <mat-select>
                                        </mat-select>
                                    </mat-form-field>
                                    <button mat-icon-button color="warn" class="m-1"><mat-icon>close</mat-icon></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr/>
                </div>
        
                <!-- Mission details -->
                <div *ngIf="preChosenMissions">
                    <div class="d-flex flex-row flex-wrap mt-2">
                        <mat-form-field appearance="fill" class="m-1 flex-mission-input">
                            <mat-label>Primary objective</mat-label>
                            <mat-select [(ngModel)]="mission.primary" (ngModelChange)="saveSettings()">
                                <mat-option *ngFor="let primaryObjective of missionPrimaryObjectives" [value]="primaryObjective">
                                    {{ primaryObjective }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="fill" class="m-1 flex-mission-input">
                            <mat-label>Secondary objective</mat-label>
                            <mat-select [(ngModel)]="mission.secondary" (ngModelChange)="saveSettings()">
                                <mat-option *ngFor="let secondaryObjective of missionSecondaryObjectives" [value]="secondaryObjective">
                                    {{ secondaryObjective }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="fill" class="m-1 flex-mission-input">
                            <mat-label>Biome</mat-label>
                            <mat-select [(ngModel)]="mission.biome" (ngModelChange)="saveSettings()">
                                <mat-option *ngFor="let biome of biomes" [value]="biome">
                                    {{ biome }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="fill" class="mission-number-input m-1">
                            <mat-label>Length</mat-label>
                            <input
                                matInput
                                type="number"
                                min="1"
                                max="3"
                                id="mission-length"
                                [(ngModel)]="mission.length"
                                (ngModelChange)="saveSettings()">
                        </mat-form-field>
                        <mat-form-field appearance="fill" class="mission-number-input m-1">
                            <mat-label>Complexity</mat-label>
                            <input
                                matInput
                                type="number"
                                min="1"
                                max="3"
                                id="mission-complexity"
                                [(ngModel)]="mission.complexity"
                                (ngModelChange)="saveSettings()">
                        </mat-form-field>
                        <mat-form-field appearance="fill" class="m-1 flex-mission-input">
                            <mat-label>Warnings</mat-label>
                            <mat-select [(ngModel)]="mission.warnings" (ngModelChange)="saveSettings()" multiple>
                                <mat-option
                                    [value]="warning"
                                    *ngFor="let warning of warnings"
                                    [disabled]="mission.warnings.length === 2 && !mission.warnings.includes(warning)">
                                    {{ warning }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                        <mat-form-field appearance="fill" class="m-1 flex-mission-input">
                            <mat-label>Anomaly</mat-label>
                            <mat-select [(ngModel)]="mission.anomaly" (ngModelChange)="saveSettings()">
                                <mat-option [value]="null">
                                    None
                                </mat-option>
                                <mat-option *ngFor="let anomaly of anomalies" [value]="anomaly">
                                    {{ anomaly }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                </div>
        
        
                <!-- Roll a strategy -->
                <div>
                    <button
                        class="m-2"
                        mat-raised-button
                        color="primary"
                        (click)="rollStrat()">
                        Roll a strategy
                    </button>
                    <button
                        *ngIf="strat"
                        mat-icon-button
                        [matMenuTriggerFor]="clipboardMenu"
                        #tooltip="matTooltip"
                        matTooltip="Copy to clipboard"
                        matTooltipShowDelay="500">
                        <mat-icon class="white-icon">content_copy</mat-icon>
                    </button>
                    <button
                        *ngIf="queuedStrats.length > 0"
                        mat-icon-button
                        #tooltip="matTooltip"
                        matTooltip="Show queued strategies"
                        matTooltipShowDelay="500"
                        (click)="drawer.toggle()">
                        <mat-icon class="white-icon">list_alt</mat-icon>
                    </button>
                    <button
                        *ngIf="strat?.generateDynamicContent"
                        mat-icon-button
                        #tooltip="matTooltip"
                        [matTooltip]="(strat?.generateDynamicContent && strat?.dynamicContent ?
                            'Re-generate randomized strategy decisions' :
                            'Generate randomized strategy decisions')"
                        matTooltipShowDelay="500"
                        (click)="generateDynamicContent()">
                        <mat-icon class="white-icon">refresh</mat-icon>
                    </button>
        
                    <!-- Copy intro/strategy to clipboard -->
                    <mat-menu #clipboardMenu="matMenu">
                        <button mat-menu-item (click)="copyText(false, true)">
                            Strat
                        </button>
                        <button mat-menu-item (click)="copyText(true, false)">
                            Intro
                        </button>
                        <button mat-menu-item (click)="copyText(true, true)">
                            Both
                        </button>
                    </mat-menu>
                </div>
        
                <!-- Rolled strategy -->
                <div class="active-strategy-container">
                    <div *ngIf="strat" class="d-flex strat-title-container">
                        <h1 class="strat-title"><b>#{{ strat.id }}: {{ strat.name }}</b></h1>
                        <hr/>
                        <div class="strat-info-section">
                            <h2 class="strat-info-section-title">Summary</h2>
                            <div>{{ strat.summary }}</div>
                            <div>
                                <div *ngFor="let tag of tags">
                                    <ng-container *ngIf="strat?.tags?.includes(tag.type)">
                                        {{ tag.type }}
                                        <mat-icon
                                            class="white-icon"
                                            #tooltip="matTooltip"
                                            [matTooltip]="tag.description"
                                            matTooltipShowDelay="250">
                                            {{ tag.icon }}
                                        </mat-icon>
                                    </ng-container>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div *ngIf="strat?.details" class="strat-info-section">
                        <h2 class="strat-info-section-title">Additional details</h2>
                        <div>{{ strat?.details }}</div>
                    </div>
                    <div *ngIf="strat?.writtenRequirements" class="strat-info-section">
                        <h2 class="strat-info-section-title">Requirements</h2>
                        <div>{{ strat?.writtenRequirements }}</div>
                    </div>
                    <div *ngIf="strat?.dynamicContent" class="strat-info-section">
                        <h2 class="strat-info-section-title">This time around</h2>
                        <div>{{ strat?.dynamicContent }}</div>
                    </div>
                </div>
            </div>
        </div>
    </mat-drawer-content>
</mat-drawer-container>
